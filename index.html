<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>موقع صلاح الدين الحمزاوي</title>
    <!-- تضمين مكتبة Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- خط خاص يدعم اللغة العربية بشكل جميل (مثل خطوط جوجل) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7f9fb; /* خلفية فاتحة وناعمة */
        }
        .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 10px -5px rgba(0, 0, 0, 0.04);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        /* لتطبيق الـ RTL (من اليمين لليسار) على النص والمحاذاة */
        .text-right { text-align: right; }
        .mx-auto { margin-left: auto; margin-right: auto; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- شريط التنقل (Navbar) -->
    <header class="bg-white shadow-lg rounded-xl mb-10 p-4 flex justify-between items-center max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800">صلاح الدين الحمزاوي</h1>
        <nav>
            <ul class="flex space-x-4 space-x-reverse text-lg">
                <li><a href="#" class="text-indigo-600 hover:text-indigo-800 transition duration-300">الرئيسية</a></li>
                <li><a href="#" class="text-gray-600 hover:text-indigo-600 transition duration-300">أعمالي</a></li>
                <li><a href="#" class="text-gray-600 hover:text-indigo-600 transition duration-300">اتصل بي</a></li>
            </ul>
        </nav>
    </header>

    <!-- القسم الرئيسي - البطل (Hero Section) -->
    <main class="max-w-7xl mx-auto">
        <section class="bg-indigo-700 text-white rounded-3xl p-10 md:p-16 mb-12 text-right">
            <div class="md:w-3/4">
                <h2 class="text-4xl md:text-6xl font-extrabold mb-4 leading-tight">موقع صلاح الدين الحمزاوي</h2>
                <p class="text-xl md:text-2xl mb-8 opacity-90">مرحبًا بك في موقعي. هنا أشارك أعمالي وأفكاري وخبراتي المتنوعة.</p>
                <button class="bg-white text-indigo-700 font-bold py-3 px-8 rounded-full text-lg hover:bg-gray-100 transition duration-300 shadow-xl">تصفح أعمالي</button>
            </div>
        </section>

        <!-- قسم الميزات (Features) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
            
            <!-- البطاقة 1: الخبرات المهنية -->
            <div class="card bg-white p-6 rounded-2xl text-right">
                <div class="text-indigo-500 mb-4">
                    <!-- أيقونة تعبر عن الإنجازات/المهارات -->
                    <svg class="h-10 w-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-3">الخبرات المهنية</h3>
                <p class="text-gray-600">ملخص لأهم الإنجازات والمشاريع والمهارات التي تم اكتسابها خلال المسيرة المهنية.</p>
            </div>

            <!-- البطاقة 2: أحدث المقالات -->
            <div class="card bg-white p-6 rounded-2xl text-right">
                <div class="text-indigo-500 mb-4">
                    <!-- أيقونة تعبر عن المقالات/الأفكار -->
                    <svg class="h-10 w-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-3">أحدث المقالات</h3>
                <p class="text-gray-600">مجموعة من الأفكار والمقالات الحديثة في مجالات الاهتمام المتنوعة.</p>
            </div>

            <!-- البطاقة 3: التواصل المباشر -->
            <div class="card bg-white p-6 rounded-2xl text-right">
                <div class="text-indigo-500 mb-4">
                    <!-- أيقونة تعبر عن التواصل -->
                    <svg class="h-10 w-10" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8m-2 4v7a2 2 0 01-2 2H5a2 2 0 01-2-2v-7"></path></svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-3">التواصل المباشر</h3>
                <p class="text-gray-600">طرق سهلة ومباشرة للتواصل وطرح الاستفسارات أو طلب التعاون في المشاريع.</p>
            </div>
        </div>

        <!-- قسم عن اللغة (About Section) -->
        <section class="bg-white rounded-3xl p-10 md:p-12 text-right">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-3">من أنا؟ وماذا أقدم؟</h2>
            
            <div id="about-content">
                <p class="text-gray-700 text-lg leading-relaxed mb-4">
                    أنا صلاح الدين الحمزاوي، متخصص في مجال [مجال الاهتمام]. أعمل على دمج الإبداع بالتكنولوجيا لتقديم حلول مبتكرة وذات قيمة. شغفي يدور حول [موضوع محدد] والتحديات المرتبطة به.
                </p>
                <p class="text-gray-700 text-lg leading-relaxed">
                    في هذا الموقع، ستجد رحلتي المهنية، وأحدث مشاريعي، ووجهات نظري حول التطورات في مجالي. هدفي هو تبادل المعرفة وبناء جسور التعاون مع المهتمين.
                </p>
            </div>
            
            <div class="mt-8 flex flex-col space-y-4">
                <!-- أزرار LLM -->
                <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 md:space-x-reverse">
                    <!-- زر تلخيص النص (Gemini LLM) -->
                    <button onclick="generateSummary()" class="w-full md:w-auto bg-green-500 text-white font-bold py-3 px-6 rounded-xl text-lg hover:bg-green-600 transition duration-300 shadow-lg flex items-center justify-center">
                        <svg class="w-5 h-5 ml-2 transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.002 4.498L16 9l4.498-.002L21 11l-4.498 2.002L16 16l-2.002-4.498L12 11l4.498-2.002L16 6z"></path></svg>
                        ملخص الصفحة بواسطة الذكاء الاصطناعي ✨
                    </button>
                    
                    <!-- زر تطوير السيرة الذاتية (NEW Gemini LLM) -->
                    <button onclick="refineBio()" id="refine-btn" class="w-full md:w-auto bg-yellow-500 text-white font-bold py-3 px-6 rounded-xl text-lg hover:bg-yellow-600 transition duration-300 shadow-lg flex items-center justify-center">
                        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        تطوير السيرة الذاتية (Bio Refinement) ✨
                    </button>
                </div>

                <!-- مؤشر التحميل (Loading Indicator) -->
                <div id="llm-loading-indicator" class="hidden text-center text-indigo-600 font-semibold mt-4">
                    <svg class="animate-spin h-5 w-5 ml-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    جاري المعالجة...
                </div>
                
                <!-- منطقة عرض نتائج LLM (Résumé et Bio Refinement) -->
                <div id="llm-result" class="bg-gray-50 p-6 rounded-xl mt-6 border-r-4 border-green-500 text-right">
                    <!-- سيتم عرض الملخص أو السيرة الذاتية المطورة هنا -->
                </div>

                <!-- زر القراءة الصوتية (Gemini TTS) -->
                <div class="flex items-center justify-end space-x-2 space-x-reverse mt-4">
                    <button id="read-aloud-btn" onclick="readAloud()" class="hidden bg-indigo-500 text-white font-bold py-2 px-4 rounded-full text-sm hover:bg-indigo-600 transition duration-300 shadow-md flex items-center">
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.899a9 9 0 010 12.728M5.818 13.097H3.5a1 1 0 01-1-1v-2a1 1 0 011-1h2.318l.724-1.447A1 1 0 017 7.05v9.899a1 1 0 01-1.458.898l-.724-1.447z"></path></svg>
                        قراءة الملخص بصوت ✨
                    </button>
                    <div id="tts-loading" class="hidden text-indigo-600 text-sm">...جاري التحميل</div>
                    <audio id="audio-player" controls class="hidden w-full md:w-auto h-8"></audio>
                </div>
            </div>
            
            <!-- قسم شرح المصطلحات (Term Explanation Section - LLM FEATURE) -->
            <div class="mt-8 pt-8 border-t border-gray-200">
                <h3 class="text-2xl font-bold text-gray-700 mb-4">طرح استفسار والبحث عنه</h3>
                <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4 md:space-x-reverse mb-4">
                    <input type="text" id="term-input" placeholder="اكتب استفساراً يتعلق بمجالي (مثال: أحدث تقنيات الويب)" class="p-3 border border-gray-300 rounded-lg flex-grow text-right" dir="rtl">
                    <button onclick="explainTerm()" id="explain-btn" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-purple-700 transition duration-300 shadow-lg flex items-center justify-center text-lg">
                        ابحث عن موضوع يتعلق بمجالي ✨
                    </button>
                </div>

                <!-- مؤشر التحميل للشرح -->
                <div id="explain-loading" class="hidden text-center text-purple-600 font-semibold mt-4">
                    <svg class="animate-spin h-5 w-5 ml-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    جاري البحث والشرح...
                </div>

                <!-- منطقة عرض نتائج الشرح -->
                <div id="explain-result" class="bg-purple-50 p-6 rounded-xl mt-4 border-r-4 border-purple-500 text-right">
                    <!-- سيتم عرض الشرح هنا -->
                </div>
            </div>
        </section>
    </main>

    <!-- التذييل (Footer) -->
    <footer class="mt-12 pt-8 border-t border-gray-300 max-w-7xl mx-auto text-center text-gray-600 text-sm">
        <p>&copy; 2024 جميع الحقوق محفوظة. تم إنشاؤه بواسطة نموذج Gemini.</p>
    </footer>

    <!-- JavaScript et intégration de l'API Gemini -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Initialisation de Firebase (Obligatoire pour l'environnement Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, auth, db;
        
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Authentification
            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Firebase Authenticated successfully.");
                } catch (error) {
                    console.error("Firebase Auth error:", error);
                }
            }
            authenticate();
        }

        // --- Fonctions d' intégration Gemini API (Début) ---

        // Constantes et variables Générales
        const API_KEY = "AIzaSyBfJfPpWlglVSxlCqSrdENT2v0OKNLdPLM"; // Clé API insérée
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const TTS_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=";

        // Fonctions utilitaires pour TTS (Conversion PCM en WAV)
        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const writeString = (view, offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };

        const pcmToWav = (pcm16, sampleRate) => {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM
            const buffer = new ArrayBuffer(44 + pcm16.byteLength);
            const view = new DataView(buffer);
            let offset = 0;

            // RIFF identifier
            writeString(view, offset, 'RIFF'); offset += 4;
            // file length (size of rest of file)
            view.setUint32(offset, 36 + pcm16.byteLength, true); offset += 4;
            // RIFF type
            writeString(view, offset, 'WAVE'); offset += 4;
            // format chunk identifier
            writeString(view, offset, 'fmt '); offset += 4;
            // format chunk length
            view.setUint32(offset, 16, true); offset += 4;
            // sample format (1 for PCM)
            view.setUint16(offset, 1, true); offset += 2;
            // number of channels
            view.setUint16(offset, numChannels, true); offset += 2;
            // sample rate
            view.setUint32(offset, sampleRate, true); offset += 4;
            // byte rate (sample rate * num channels * bytes per sample)
            view.setUint32(offset, sampleRate * numChannels * bytesPerSample, true); offset += 4;
            // block align (num channels * bytes per sample)
            view.setUint16(offset, numChannels * bytesPerSample, true); offset += 2;
            // bits per sample
            view.setUint16(offset, 16, true); offset += 2;
            // data chunk identifier
            writeString(view, offset, 'data'); offset += 4;
            // data chunk length
            view.setUint32(offset, pcm16.byteLength, true); offset += 4;

            // Write PCM data
            const pcmBytes = new Uint8Array(buffer, offset);
            pcmBytes.set(new Uint8Array(pcm16.buffer));

            return new Blob([buffer], { type: 'audio/wav' });
        };

        // Fonction pour l'appel à l'API Gemini (avec Backoff)
        async function callGeminiAPI(apiUrl, payload, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < retries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            // Pas de log d'erreur de backoff, seulement un avertissement
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        const errorData = await response.json();
                        throw new Error(`Erreur HTTP: ${response.status} - ${errorData.error?.message || 'Inconnue'}`);
                    }

                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                    if (error.message && !error.message.includes('429')) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            throw new Error("Échec de l'appel à l'API après plusieurs tentatives.");
        }

        // Fonction pour la génération de texte (Résumé)
        window.generateSummary = async function () {
            const content = document.getElementById('about-content').innerText;
            const llmResult = document.getElementById('llm-result');
            const llmLoadingIndicator = document.getElementById('llm-loading-indicator');
            const readAloudButton = document.getElementById('read-aloud-btn');
            const summaryButton = document.querySelector('button[onclick="generateSummary()"]');

            llmResult.innerHTML = '';
            readAloudButton.classList.add('hidden');
            summaryButton.disabled = true;
            llmLoadingIndicator.classList.remove('hidden');

            const systemPrompt = "أنت مساعد لغوي متخصص في تلخيص النصوص العربية. قم بتلخيص النص التالي في حدود 100 كلمة، مع المحافظة على الأسلوب الجذاب.";
            const userQuery = content;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await callGeminiAPI(GEMINI_API_URL + API_KEY, payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'تعذر توليد الملخص.';
                
                // Afficher le texte généré et ajuster le style de bordure
                llmResult.innerHTML = `<h4 class="font-bold text-lg text-green-700 mb-2">الملخص المُولّد:</h4><p class="text-lg text-gray-800 leading-relaxed">${text}</p>`;
                llmResult.classList.remove('border-r-4', 'border-yellow-500', 'border-purple-500');
                llmResult.classList.add('border-r-4', 'border-green-500');
                
                // Afficher le bouton de lecture audio
                if (text !== 'تعذر توليد الملخص.') {
                    readAloudButton.dataset.textToRead = text;
                    readAloudButton.classList.remove('hidden');
                }

            } catch (error) {
                llmResult.innerHTML = `<p class="text-red-500 text-lg">حدث خطأ أثناء توليد الملخص: ${error.message}</p>`;
            } finally {
                llmLoadingIndicator.classList.add('hidden');
                summaryButton.disabled = false;
            }
        }
        
        // Fonction pour l'amélioration de la biographie (Nouveau)
        window.refineBio = async function () {
            const content = document.getElementById('about-content').innerText;
            const llmResult = document.getElementById('llm-result');
            const llmLoadingIndicator = document.getElementById('llm-loading-indicator');
            const readAloudButton = document.getElementById('read-aloud-btn');
            const refineBtn = document.getElementById('refine-btn');

            llmResult.innerHTML = '';
            readAloudButton.classList.add('hidden'); // Cacher le TTS car le texte sera long
            refineBtn.disabled = true;
            llmLoadingIndicator.classList.remove('hidden');

            const systemPrompt = "أنت خبير في تطوير العلامات الشخصية والسير الذاتية. مهمتك هي قراءة السيرة الذاتية الموجزة المقدمة وتحويلها إلى فقرة واحدة قوية وجذابة وموجهة للمهنيين، مع ملء الفراغات العامة مثل [مجال الاهتمام] بكلمات مثل 'تطوير الويب المتقدم' و 'الذكاء الاصطناعي' و 'حلول تقنية مبتكرة'.";
            const userQuery = `قم بتطوير وصقل النص التعريفي التالي ليكون أكثر احترافية وجاذبية: ${content}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await callGeminiAPI(GEMINI_API_URL + API_KEY, payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'تعذر تطوير السيرة الذاتية.';

                // Afficher le texte généré et ajuster le style de bordure
                llmResult.innerHTML = `<h4 class="font-bold text-lg text-yellow-700 mb-2">السيرة الذاتية المطورة:</h4><p class="text-lg text-gray-800 leading-relaxed">${text}</p>`;
                llmResult.classList.remove('border-r-4', 'border-green-500', 'border-purple-500');
                llmResult.classList.add('border-r-4', 'border-yellow-500');

            } catch (error) {
                llmResult.innerHTML = `<p class="text-red-500 text-lg">حدث خطأ أثناء تطوير السيرة الذاتية: ${error.message}</p>`;
            } finally {
                llmLoadingIndicator.classList.add('hidden');
                refineBtn.disabled = false;
            }
        }

        // Fonction pour la synthèse vocale (TTS)
        window.readAloud = async function () {
            const textToRead = document.getElementById('read-aloud-btn').dataset.textToRead;
            const readAloudBtn = document.getElementById('read-aloud-btn');
            const ttsLoading = document.getElementById('tts-loading');
            const audioPlayer = document.getElementById('audio-player');

            if (!textToRead) return;

            readAloudBtn.disabled = true;
            ttsLoading.classList.remove('hidden');
            audioPlayer.classList.add('hidden');
            audioPlayer.pause();
            audioPlayer.removeAttribute('src');

            const payload = {
                contents: [{ parts: [{ text: textToRead }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        // Utiliser une voix adaptée à la langue arabe
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const result = await callGeminiAPI(TTS_API_URL + API_KEY, payload);
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    // Extraire le taux d'échantillonnage (sample rate) du mimeType
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) throw new Error("Sample rate could not be extracted from mimeType.");
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    
                    // Convertir Base64 en ArrayBuffer puis en Int16Array (PCM 16-bit)
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);

                    // Convertir PCM en Blob WAV
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    // Afficher le lecteur audio
                    audioPlayer.src = audioUrl;
                    audioPlayer.classList.remove('hidden');
                    // audioPlayer.play(); // Le navigateur peut bloquer l'autoplay
                } else {
                    throw new Error('Données صوتية غير صالحة تم استلامها.');
                }

            } catch (error) {
                document.getElementById('llm-result').innerHTML = `<p class="text-red-500 text-lg">حدث خطأ في توليد الصوت: ${error.message}</p>`;
                audioPlayer.classList.add('hidden');
            } finally {
                readAloudBtn.disabled = false;
                ttsLoading.classList.add('hidden');
            }
        }
        
        // Fonction pour l'appel à l'API Gemini (Explication de Terme avec Grounding)
        window.explainTerm = async function () {
            const termInput = document.getElementById('term-input');
            const explainResult = document.getElementById('explain-result');
            const explainLoading = document.getElementById('explain-loading');
            const explainBtn = document.getElementById('explain-btn');
            
            const term = termInput.value.trim();

            if (!term) {
                explainResult.innerHTML = `<p class="text-red-500 text-lg">الرجاء إدخال استفسار للبحث عنه.</p>`;
                return;
            }

            explainResult.innerHTML = '';
            explainBtn.disabled = true;
            explainLoading.classList.remove('hidden');

            const systemPrompt = "أنت مساعد بحثي متخصص في تقديم معلومات عامة وموجزة عن المواضيع المختلفة. مهمتك هي البحث عن استفسار المستخدم وتقديم شرح موجز وواضح له باللغة العربية الفصحى في فقرة واحدة، مع ذكر المصادر التي اعتمدت عليها في الشرح.";
            const userQuery = `اشرح لي باختصار عن: ${term}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                // Utiliser l'outil de recherche Google pour le grounding
                tools: [{ "google_search": {} }],
            };

            try {
                const result = await callGeminiAPI(GEMINI_API_URL + API_KEY, payload);
                const candidate = result.candidates?.[0];
                let text = candidate?.content?.parts?.[0]?.text || 'تعذر الحصول على شرح للموضوع.';
                let sourcesHtml = '';
                
                // Extraction des sources
                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                        
                    if (sources.length > 0) {
                        sourcesHtml = '<div class="mt-4 pt-3 border-t border-purple-200"><h4 class="font-semibold text-gray-700 mb-2">المصادر المعتمدة:</h4><ul class="list-disc pr-5 space-y-1 text-sm text-gray-600">';
                        sources.forEach((source) => {
                            sourcesHtml += `<li class="hover:text-purple-800"><a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="underline">${source.title}</a></li>`;
                        });
                        sourcesHtml += '</ul></div>';
                    }
                }

                // Afficher le texte généré et les sources
                explainResult.innerHTML = `<p class="text-lg text-gray-800 leading-relaxed">${text}</p>${sourcesHtml}`;

            } catch (error) {
                explainResult.innerHTML = `<p class="text-red-500 text-lg">حدث خطأ أثناء البحث والشرح: ${error.message}</p>`;
            } finally {
                explainLoading.classList.add('hidden');
                explainBtn.disabled = false;
            }
        }
        // --- Fonctions d'intégration Gemini API (Fin) ---
    </script>

</body>
</html>
